name: Full Cycle Tests (k8s)

on:
  workflow_dispatch: # Allows manual triggering

jobs:
  full_cycle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure Docker Daemon
        run: |
          echo '{
            "registry-mirrors": ["https://mirror.gcr.io"]
          }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Set up Kind
        uses: helm/kind-action@v1.0.0
        with:
          version: v0.23.0
          cluster_name: kind
          wait: 300s

      - name: Deploy NGINX Ingress Controller
        run: |
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
          kubectl patch svc ingress-nginx-controller -n ingress-nginx -p '{"spec": {"type": "NodePort"}}'

      #- name: Wait for NGINX Ingress Controller to Be Ready
      #  run: |
      #    echo "Waiting for NGINX Ingress Controller to be ready..."
      #    kubectl wait --namespace ingress-nginx \
      #      --for=condition=ready pod \
      #      --selector=app.kubernetes.io/name=ingress-nginx \
      #      --timeout=300s          

      - name: Wait for NodePort
        run: |
          echo "Waiting for NodePort..."
          while [ -z "$NODE_PORT" ]; do
            NODE_PORT=$(kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath="{.spec.ports[0].nodePort}")
            [ -z "$NODE_PORT" ] && sleep 10
          done
          NODE_IP=$(kubectl get nodes -o jsonpath="{.items[0].status.addresses[0].address}")
          PUBLIC_IP=$(curl -s https://api.ipify.org)
          echo "Node IP: $NODE_IP"
          echo "Public IP: $PUBLIC_IP"
          echo "Node Port: $NODE_PORT"
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "NODE_PORT=$NODE_PORT" >> $GITHUB_ENV 

      - name: Build Receiver Docker Image
        run: |
          docker build -t receiver:unique-tag -f test/integration/docker/receiver/Dockerfile .

      - name: Load Receiver Docker Image into Kind
        run: |
          kind load docker-image receiver:unique-tag          

      - name: Create Receiver Deployment and Service
        run: kubectl apply -f .github/workflows/k8s/full/receiver-deployment.yml

      - name: Wait for Receiver Deployment to Be Ready
        run: |
          echo "Waiting for Receiver Deployment to be ready..."
          kubectl wait --namespace default \
            --for=condition=ready pod \
            --selector=app=receiver \
            --timeout=300s     

      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc > /dev/null \
          && echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list \
          && sudo apt update && sudo apt install ngrok  

      - name: Set ngrok Authtoken
        run: ngrok authtoken ${{ secrets.NGROK_AUTHTOKEN }}          

      - name: Expose Receiver Service with ngrok
        run: |
          kubectl port-forward svc/receiver-service 8080:80 &
          sleep 5
          ngrok http 8080 --log=stdout &

      - name: Add Delay for ngrok to Start
        run: sleep 10     

      - name: Verify Test URL
        run: |
          NGROK_URL=$(curl --silent --show-error http://127.0.0.1:4040/api/tunnels | jq -r .tunnels[0].public_url)
          echo "Test URL: $NGROK_URL"
          curl -v $NGROK_URL        

      - name: Debugging - List all pods and services
        if: always()
        run: |
          kubectl get pods --all-namespaces
          kubectl get svc --all-namespaces
          kubectl get ingress --all-namespaces            
